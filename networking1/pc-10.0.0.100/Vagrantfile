# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(2) do |config|
  config.vm.box = "ubuntu desktop amd64 15.10"
  config.ssh.private_key_path= "/Users/demouser/vm/keys/vagrant"

  config.vm.synced_folder "~/vm/data", "/vagrant_data"

  config.vm.provider "virtualbox" do |vb|
    # vb.gui = true
    vb.name = "pc-10.0.0.100"
    vb.customize ["modifyvm", :id, "--nic2", "null"]
  end

  config.vm.provision "shell", inline: <<-SHELL
    sudo apt-get update
    sudo cat >> /etc/network/interfaces <<END
auto eth1
iface eth1 inet static
  address 10.0.0.100
  netmask 255.255.255.0
  post-up route add -net 192.168.1.0 netmask 255.255.255.0 gw 10.0.0.254
  post-up route add -net 172.16.0.0 netmask 255.255.255.0 gw 10.0.0.254
  post-up /sbin/iptables-restore -c < /etc/iptables.rules
END
    sudo apt-get install dnsmasq
    sudo sed -i -e 's/^#interface=$/interface=eth1/' /etc/dnsmasq.conf
    # enable IP forwarding and NAT
    sudo sed -i -e 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
    sudo cat > /etc/iptables.rules <<END
# Generated by iptables-save v1.4.21 on Wed Nov  4 02:06:14 2015
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -o eth0 -j MASQUERADE
COMMIT
# Completed on Wed Nov  4 02:06:14 2015
# Generated by iptables-save v1.4.21 on Wed Nov  4 02:06:14 2015
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -i eth1 -j ACCEPT
-A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -j ACCEPT
-A FORWARD -i lo -o lo -j ACCEPT
COMMIT
# Completed on Wed Nov  4 02:06:14 2015
END
    # Upgrade packages so students don't get prompted for updates
    sudo apt-get upgrade -y
    sudo shutdown -h now
  SHELL
end
